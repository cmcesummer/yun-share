<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Abort APi example</title>
        <style>
            .wrapper {
                width: 70%;
                max-width: 800px;
                margin: 0 auto;
            }

            video {
                max-width: 100%;
            }

            .videoWrapper,
            .abort {
                display: none;
            }

            progress {
                display: block;
                width: 100%;
            }

            div div {
                margin-bottom: 10px;
            }
        </style>
    </head>

    <body>
        <div class="wrapper">
            <h1>Simple offline video player</h1>
            <div class="controls">
                <button class="download">Download video</button>
                <button class="abort">Cancel download</button>
                <p class="reports" id="reports"></p>
            </div>
            <div class="videoWrapper">
                <p>Sintel © copyright Blender Foundation | <a href="http://www.sintel.org/">www.sintel.org</a>.</p>
            </div>
        </div>
    </body>
    <script>
        function downTimeFactory(param) {
            const { log, cb, interval = 1000 } = param;
            let { ms } = param;
            const startTime = new Date().getTime();
            let count = 0,
                timeFlag = null;
            if (ms > 0) {
                timeFlag = setTimeout(core, interval);
            }
            function core() {
                // 当前循环计数
                count = count + 1;
                // 计算剩余时间
                ms -= interval;
                if (ms < 0) {
                    clearTimeout(timeFlag);
                    return;
                }
                // 执行逻辑
                if (cb) cb(ms);
                // 误差时间 = 当前时间 - 逻辑时间
                const errorTime = new Date().getTime() - (startTime + count * interval);
                // 下次执行时间
                let nextTime = interval - errorTime;
                if (nextTime < 0) {
                    // 这种情况下说明当前进程阻塞时间大于了 interval 时间，
                    // 只能到下个进程去纠正多余时间
                    nextTime = 0;
                }
                setTimeout(core, nextTime);
                if (log) console.log(`误差：${errorTime} ms，下一次执行：${nextTime} ms 后，离开始还有：${ms} ms`);
            }
        }
        downTimeFactory({
            ms: 5000,
            log: true,
            cb: function() {
                let i = 0;
                reports.innerHTML = 0;
                console.log(reports.innerHTML);
                while (i <= 10) {
                    i++;
                    reports.innerHTML = i;
                }
                console.log(reports.innerHTML);
            }
        });
    </script>
</html>
